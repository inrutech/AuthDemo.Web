<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USDT æˆæƒç¤ºä¾‹ (æµ‹è¯•ç½‘ç‰ˆæœ¬)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.0/web3.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; text-align: center; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        button { padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; color: white; background-color: #007bff; transition: background-color 0.3s; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        .status { margin-top: 20px; padding: 10px; border-radius: 5px; min-height: 40px; font-weight: bold; word-wrap: break-word; }
        .connected { background-color: #e6ffe6; color: #008000; }
        .error { background-color: #ffe6e6; color: #cc0000; }
        .warning { color: orange; }
    </style>
</head>
<body>

<div class="container">
    <h1>USDT ä»£å¸æˆæƒç¤ºä¾‹ (æµ‹è¯•ç½‘ç‰ˆæœ¬)</h1>
    
    <div id="status" class="status">æœªè¿æ¥é’±åŒ…</div>
    
    <button onclick="connectWallet()">è¿æ¥é’±åŒ… (BSC Testnet/TRON Nile)</button>
    <button id="approve-button" onclick="approveToken()" disabled>æˆæƒ USDT (æµ‹è¯•ç½‘)</button>

    <p style="margin-top: 30px;">
        <strong class="warning">--- ğŸš¨ æ›¿æ¢è­¦å‘Š ğŸš¨ ---</strong>
        <br>
        <strong>æ‚¨å¿…é¡»æ›¿æ¢ä»¥ä¸‹ä»£ç ä¸­çš„ `YOUR_..._SPENDER_ADDRESS` ä¸ºæ‚¨åœ¨ã€æµ‹è¯•ç½‘ã€‘éƒ¨ç½²çš„åˆçº¦åœ°å€ï¼</strong>
    </p>
</div>

<script>
    // --- é…ç½®: [æµ‹è¯•ç½‘] USDT ä»£å¸å’Œ Spender åœ°å€ ---
    // BSC æµ‹è¯•ç½‘ USDT åœ°å€
    const BSC_TOKEN_ADDRESS = '0x337610d27c682E347C9cD60BD4b3b107C9d34dDd'; 
    // TRON Nile æµ‹è¯•ç½‘ USDT åœ°å€
    const TRON_TOKEN_ADDRESS = 'TXYZopYRdj2D9XRtbG4wjrPOcLo7wEa9bV'; 

    // ğŸš¨ å¿…é¡»æ›¿æ¢ä¸ºæ‚¨çš„ç›®æ ‡åˆçº¦åœ°å€ (Spender) ğŸš¨
    const BSC_SPENDER_ADDRESS = 'YOUR_BSC_SPENDER_ADDRESS'; // æ›¿æ¢ä¸ºä½ åœ¨ BSC æµ‹è¯•ç½‘çš„åˆçº¦åœ°å€
    const TRON_SPENDER_ADDRESS = 'YOUR_TRON_SPENDER_ADDRESS'; // æ›¿æ¢ä¸ºä½ åœ¨ TRON Nile æµ‹è¯•ç½‘çš„åˆçº¦åœ°å€

    // æˆæƒé‡‘é¢ (ä½¿ç”¨ uint256 çš„æœ€å¤§å€¼ï¼Œä»£è¡¨ "æ— é™" æˆæƒ)
    const MAX_APPROVAL_AMOUNT = '0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff';

    let currentNetwork = null;
    let currentAccount = null;
    let web3 = null;

    // --- çŠ¶æ€æ›´æ–°å‡½æ•° ---
    function updateStatus(message, type = 'connected') {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = message;
        statusDiv.className = `status ${type}`; // 'connected', 'error'
        document.getElementById('approve-button').disabled = !currentAccount;
    }

    // --- è¿æ¥é’±åŒ… (ä¸»å…¥å£) ---
    async function connectWallet() {
        if (window.tronWeb) {
            currentNetwork = 'TRON';
            await connectTron();
        } else if (window.ethereum) {
            currentNetwork = 'BSC';
            await connectEVM();
        } else {
            resetState();
            updateStatus('æœªæ£€æµ‹åˆ°å…¼å®¹çš„é’±åŒ…æ’ä»¶ (å¦‚ TronLink æˆ– MetaMask)ã€‚', 'error');
        }
    }

    // --- EVM (BSC) è¿æ¥é€»è¾‘ ---
    async function connectEVM() {
        try {
            web3 = new Web3(window.ethereum);
            updateStatus('æ­£åœ¨è¯·æ±‚è¿æ¥ BSC æµ‹è¯•ç½‘é’±åŒ…...');
            
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            currentAccount = accounts[0];
            
            const chainId = await window.ethereum.request({ method: 'eth_chainId' });
            // å˜æ›´: BSC æµ‹è¯•ç½‘çš„ Chain ID æ˜¯ '0x61' (åå…­è¿›åˆ¶çš„97)
            if (chainId !== '0x61') {
                resetState();
                updateStatus(`è¯·å°†é’±åŒ…ç½‘ç»œåˆ‡æ¢åˆ° BSC æµ‹è¯•ç½‘ (BSC Testnet)ã€‚å½“å‰ç½‘ç»œ ID: ${chainId}`, 'error');
                return;
            }

            currentNetwork = 'BSC';
            updateStatus(`å·²è¿æ¥ BSC æµ‹è¯•ç½‘: ${currentAccount.substring(0, 6)}...${currentAccount.slice(-4)}`);
        } catch (error) {
            resetState();
            updateStatus(`BSC é’±åŒ…è¿æ¥å¤±è´¥: ${error.message}`, 'error');
        }
    }

    // --- TRON è¿æ¥é€»è¾‘ ---
    async function connectTron() {
        try {
            updateStatus('æ­£åœ¨ç­‰å¾… TRON é’±åŒ…å°±ç»ª...');
            
            const res = await window.tronLink.request({ method: 'tron_requestAccounts' });
            if (res.code === 200) {
                // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¯ Nile ç½‘
                if (window.tronWeb.fullNode.host.includes('nileex')) {
                    currentAccount = window.tronWeb.defaultAddress.base58;
                    currentNetwork = 'TRON';
                    updateStatus(`å·²è¿æ¥ TRON Nile æµ‹è¯•ç½‘: ${currentAccount.substring(0, 6)}...${currentAccount.slice(-4)}`);
                } else {
                    resetState();
                    updateStatus('è¯·å°† TronLink é’±åŒ…åˆ‡æ¢åˆ° Nile æµ‹è¯•ç½‘ (Nile Test Network)ã€‚', 'error');
                }
            } else {
                 throw new Error("TRON è´¦æˆ·è¯·æ±‚è¢«æ‹’ç»ã€‚");
            }
        } catch (error) {
            resetState();
            updateStatus(`TRON é’±åŒ…è¿æ¥å¤±è´¥: ${error.message}`, 'error');
        }
    }

    // --- é‡ç½®çŠ¶æ€ ---
    function resetState() {
        currentAccount = null;
        currentNetwork = null;
        document.getElementById('approve-button').disabled = true;
    }

    // --- æˆæƒé€»è¾‘åˆ†å‘å™¨ ---
    async function approveToken() {
        if (!currentAccount) {
            updateStatus('è¯·å…ˆè¿æ¥é’±åŒ…ï¼', 'error');
            return;
        }

        if (currentNetwork === 'BSC') {
            await approveBSCToken();
        } else if (currentNetwork === 'TRON') {
            await approveTRONToken();
        }
    }

    // --- BSC (EVM) æˆæƒå®ç° ---
    async function approveBSCToken() {
        if (BSC_SPENDER_ADDRESS === 'YOUR_BSC_SPENDER_ADDRESS') {
             updateStatus('é”™è¯¯ï¼šè¯·åœ¨ä»£ç ä¸­æ›¿æ¢ BSC_SPENDER_ADDRESSï¼', 'error');
             return;
        }
        
        updateStatus('æ­£åœ¨è¯·æ±‚ BSC æµ‹è¯•ç½‘ (USDT) ä»£å¸æˆæƒ...');
        const abi = [{"constant": false, "inputs": [{"name": "spender", "type": "address"}, {"name": "amount", "type": "uint256"}], "name": "approve", "outputs": [{"name": "", "type": "bool"}], "type": "function"}];
        const tokenContract = new web3.eth.Contract(abi, BSC_TOKEN_ADDRESS);
        
        try {
            const transaction = await tokenContract.methods.approve(BSC_SPENDER_ADDRESS, MAX_APPROVAL_AMOUNT).send({ from: currentAccount });
            updateStatus(`BSC æˆæƒæˆåŠŸï¼äº¤æ˜“å“ˆå¸Œ: ${transaction.transactionHash.substring(0, 10)}...`);
            alert('BSC æµ‹è¯•ç½‘ USDT æˆæƒæˆåŠŸï¼');
        } catch (error) {
            if (error.code === 4001) {
                updateStatus('ç”¨æˆ·æ‹’ç»äº† BSC æˆæƒè¯·æ±‚ã€‚', 'error');
            } else {
                updateStatus(`BSC æˆæƒå¤±è´¥: ${error.message}`, 'error');
            }
        }
    }

    // --- TRON æˆæƒå®ç° ---
    async function approveTRONToken() {
        if (TRON_SPENDER_ADDRESS === 'YOUR_TRON_SPENDER_ADDRESS') {
             updateStatus('é”™è¯¯ï¼šè¯·åœ¨ä»£ç ä¸­æ›¿æ¢ TRON_SPENDER_ADDRESSï¼', 'error');
             return;
        }
        
        updateStatus('æ­£åœ¨è¯·æ±‚ TRON Nile æµ‹è¯•ç½‘ (USDT) ä»£å¸æˆæƒ...');
        try {
            const contract = await window.tronWeb.contract().at(TRON_TOKEN_ADDRESS);
            const txID = await contract.approve(TRON_SPENDER_ADDRESS, MAX_APPROVAL_AMOUNT).send({ feeLimit: 150000000, callValue: 0 });

            if (txID) {
                updateStatus(`TRON æˆæƒäº¤æ˜“å·²å‘é€ï¼äº¤æ˜“å“ˆå¸Œ: ${txID.substring(0, 10)}...`);
                alert('TRON æˆæƒè¯·æ±‚å·²å‘é€ï¼Œè¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤ï¼');
            } else {
                 throw new Error("TronWeb æœªè¿”å›äº¤æ˜“IDã€‚");
            }
        } catch (error) {
            const errorMessage = typeof error === 'string' ? error : error.message;
            if (errorMessage.includes('User denied') || errorMessage.includes('User cancelled')) {
                updateStatus('ç”¨æˆ·æ‹’ç»äº† TRON æˆæƒè¯·æ±‚ã€‚', 'error');
            } else {
                updateStatus(`TRON æˆæƒå¤±è´¥: ${errorMessage}`, 'error');
            }
        }
    }

    // --- äº‹ä»¶ç›‘å¬ ---
    function setupEventListeners() {
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => { if (accounts.length === 0) { resetState(); updateStatus('é’±åŒ…å·²æ–­å¼€è¿æ¥ã€‚', 'error'); } else { connectWallet(); } });
            window.ethereum.on('chainChanged', () => connectWallet());
        }
        if(window.tronWeb) {
            window.addEventListener('message', (e) => { if (e.data.message && e.data.message.action && (e.data.message.action === 'setAccount' || e.data.message.action === 'setNode')) { connectWallet(); } });
        }
    }

    window.addEventListener('load', () => {
        setupEventListeners();
        setTimeout(connectWallet, 500);
    });
</script>
</body>
</html>